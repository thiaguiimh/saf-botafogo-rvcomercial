<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Comissões - Ferramenta de Gestão v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f5f7; /* Apple-like light gray background */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .panel { 
            background-color: white; 
            border-radius: 1rem; /* Softer, larger radius */
            padding: 1.5rem; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Softer shadow */
        }
        .btn {
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border-radius: 0.75rem; /* 12px */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-dark {
            background-color: #1d1d1f; /* Apple's dark color */
            color: white;
        }
        .btn-dark:hover {
            background-color: #333;
        }
        .btn-dark:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
        }
        .btn-light {
            background-color: #e8e8ed;
            color: #1d1d1f;
        }
        .btn-light:hover {
            background-color: #ddd;
        }
        h1, h2, h3 {
            color: #1d1d1f;
        }
        .table-header th {
            color: #6e6e73; /* Apple's secondary text color */
            text-transform: none;
            font-size: 0.875rem;
            letter-spacing: normal;
            border-bottom: 1px solid #e8e8ed;
        }
        .table-row td {
            color: #1d1d1f;
            border-bottom: 1px solid #f5f5f7;
        }
        .form-input {
            width: 100%;
            background-color: #f5f5f7;
            border: 1px solid #f5f5f7;
            border-radius: 0.75rem;
            padding: 0.625rem 1rem;
            transition: border-color 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #0071e3; /* Apple's blue */
        }
        #auth-status { text-align: center; padding: 0.75rem; border-radius: 0.75rem; margin-bottom: 1.5rem; font-weight: 500;}
        .auth-success { background-color: rgba(49, 207, 120, 0.1); color: #1e874f; }
        .auth-fail { background-color: rgba(255, 59, 48, 0.1); color: #d1272b; }
        .loader { border: 4px solid #e8e8ed; border-top: 4px solid #1d1d1f; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="min-h-screen lg:grid lg:grid-cols-12 gap-8 p-4 lg:p-8" style="display: none;">
        
        <!-- Coluna de Controles (Esquerda) -->
        <aside class="lg:col-span-4 xl:col-span-3 flex flex-col gap-8">
            <div class="panel">
                 <h2 class="text-2xl font-bold mb-6">Parâmetros</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Pesos por Cargo</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><label for="peso_diretor" class="text-gray-600">Diretor</label><input type="number" id="peso_diretor" value="44" class="form-input w-20 text-center"></div>
                            <div class="flex justify-between items-center"><label for="peso_gerente" class="text-gray-600">Gerente</label><input type="number" id="peso_gerente" value="8" class="form-input w-20 text-center"></div>
                            <div class="flex justify-between items-center"><label for="peso_especialista" class="text-gray-600">Especialista</label><input type="number" id="peso_especialista" value="4" class="form-input w-20 text-center"></div>
                            <div class="flex justify-between items-center"><label for="peso_pleno" class="text-gray-600">Designer Pleno</label><input type="number" id="peso_pleno" value="2" class="form-input w-20 text-center"></div>
                            <div class="flex justify-between items-center"><label for="peso_junior" class="text-gray-600">Analista Júnior</label><input type="number" id="peso_junior" value="1" class="form-input w-20 text-center"></div>
                        </div>
                    </div>
                    <hr class="border-gray-100">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Comissão 2025+ (%)</h3>
                        <div class="space-y-3">
                           <div class="flex justify-between items-center"><label for="perc_2025_f1" class="text-gray-600">Faixa 1</label><input type="number" id="perc_2025_f1" value="1.0" step="0.01" class="form-input w-20 text-center"></div>
                           <div class="flex justify-between items-center"><label for="perc_2025_f2" class="text-gray-600">Faixa 2</label><input type="number" id="perc_2025_f2" value="2.0" step="0.01" class="form-input w-20 text-center"></div>
                           <div class="flex justify-between items-center"><label for="perc_2025_f3" class="text-gray-600">Faixa 3</label><input type="number" id="perc_2025_f3" value="3.4" step="0.01" class="form-input w-20 text-center"></div>
                        </div>
                    </div>
                     <hr class="border-gray-100">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Comissão Pré-2025 (%)</h3>
                        <div class="space-y-3">
                           <div class="flex justify-between items-center"><label for="perc_pre2025_f1" class="text-gray-600">Faixa 1</label><input type="number" id="perc_pre2025_f1" value="0.75" step="0.01" class="form-input w-20 text-center"></div>
                           <div class="flex justify-between items-center"><label for="perc_pre2025_f2" class="text-gray-600">Faixa 2</label><input type="number" id="perc_pre2025_f2" value="1.0" step="0.01" class="form-input w-20 text-center"></div>
                           <div class="flex justify-between items-center"><label for="perc_pre2025_f3" class="text-gray-600">Faixa 3</label><input type="number" id="perc_pre2025_f3" value="1.5" step="0.01" class="form-input w-20 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2 class="text-2xl font-bold mb-6">Lançar Contratos</h2>
                <form id="contract-form" class="space-y-4">
                    <div><label for="contract-client" class="block text-sm font-medium text-gray-600 mb-1">Cliente</label><input type="text" id="contract-client" placeholder="Nome do cliente" required class="form-input"></div>
                    <div><label for="contract-value" class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label><input type="number" id="contract-value" placeholder="500000" required class="form-input"></div>
                    <div><label for="contract-date" class="block text-sm font-medium text-gray-600 mb-1">Data</label><input type="date" id="contract-date" required class="form-input"></div>
                    <button type="submit" class="w-full btn btn-dark">Adicionar Contrato</button>
                </form>
                <hr class="my-6 border-gray-100">
                <div>
                     <h3 class="text-lg font-semibold text-gray-900 mb-2">Importar CSV</h3>
                     <p class="text-sm text-gray-500 mb-4">Arquivo com 3 colunas: Cliente, Valor, Data (AAAA-MM-DD).</p>
                     <label for="csv-file" class="w-full btn btn-light flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                        <span>Selecionar Arquivo</span>
                     </label>
                     <input type="file" id="csv-file" accept=".csv" class="hidden"/>
                     <button id="import-csv-btn" class="w-full btn btn-dark mt-3">Importar</button>
                </div>
            </div>
        </aside>

        <!-- Conteúdo Principal (Direita) -->
        <main class="lg:col-span-8 xl:col-span-9 flex flex-col gap-8 mt-8 lg:mt-0">
            <header>
                <h1 class="text-5xl font-bold tracking-tight">Dashboard</h1>
                <p class="text-lg text-gray-500 mt-2">Visão geral de performance e comissões da equipe.</p>
                <div id="auth-status" class="mt-4"></div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="panel">
                    <h3 class="font-semibold text-gray-900 mb-1">Contratos Pré-2025</h3>
                    <p class="text-4xl font-bold text-gray-800" id="vgv-pre2025">R$ 0,00</p>
                    <p class="text-sm text-gray-500 mt-2">Faixa: <span class="font-bold text-gray-700" id="faixa-pre2025">Nenhuma</span></p>
                    <p class="text-sm text-gray-500">Bônus: <span class="font-bold text-green-600" id="bonus-pre2025">R$ 0,00</span></p>
                </div>
                <div class="panel">
                    <h3 class="font-semibold text-gray-900 mb-1">Contratos 2025+</h3>
                    <p class="text-4xl font-bold text-gray-800" id="vgv-2025">R$ 0,00</p>
                    <p class="text-sm text-gray-500 mt-2">Faixa: <span class="font-bold text-gray-700" id="faixa-2025">Nenhuma</span></p>
                    <p class="text-sm text-gray-500">Bônus: <span class="font-bold text-green-600" id="bonus-2025">R$ 0,00</span></p>
                </div>
            </div>

            <div class="panel">
                <h2 class="text-2xl font-bold mb-4">Resultado de Comissões</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left">Funcionário</th>
                                <th class="px-4 py-3 text-left">Comissão Pré-2025</th>
                                <th class="px-4 py-3 text-left">Comissão 2025+</th>
                                <th class="px-4 py-3 text-left">Comissão Total</th>
                                <th class="px-4 py-3 text-left">Bônus (x Salários)</th>
                            </tr>
                        </thead>
                        <tbody id="commission-results"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel">
                 <h2 class="text-2xl font-bold mb-4">Registros</h2>
                 <div class="grid grid-cols-1 xl:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Equipe</h3>
                        <div id="team-container" class="overflow-x-auto max-h-96"></div>
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Contratos Lançados</h3>
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full">
                                 <thead class="table-header sticky top-0 bg-white">
                                    <tr><th class="px-4 py-3 text-left">Cliente</th><th class="px-4 py-3 text-left">Valor</th><th class="px-4 py-3 text-left">Data</th><th class="px-4 py-3 text-left"></th></tr>
                                </thead>
                                <tbody id="contracts-list"></tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>

        </main>
    </div>
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100">
        <div class="loader"></div>
        <p id="loading-message" class="mt-4 text-gray-600">Conectando ao banco de dados...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth;
        let contractsCollection, teamCollection;
        let unsubscribeContracts = null, unsubscribeTeam = null;

        const state = {
            team: [], contracts: [], isAuthReady: false, isDataReady: false, userId: null,
            targets: {
                pre2025: [{ faixa: 3, value: 90000000 }, { faixa: 2, value: 63000000 }, { faixa: 1, value: 36000000 }],
                from2025: [{ faixa: 3, value: 30000000 }, { faixa: 2, value: 21000000 }, { faixa: 1, value: 12000000 }]
            }
        };
        
        const initialTeamData = [
            { id: "1", name: "Marcelo Furtado", role: "Diretor Comercial", hireDate: "2025-01-01", salary: 35000.00 },
            { id: "2", name: "Paula Young", role: "Gerente Comercial", hireDate: "2025-01-01", salary: 17088.75 },
            { id: "3", name: "Carolina Chrispim", role: "Especialista", hireDate: "2024-12-31", salary: 9000.00 },
            { id: "4", name: "Nathan Lemos", role: "Especialista", hireDate: "2024-12-31", salary: 8804.98 },
            { id: "5", name: "Milena Franco", role: "Designer Pleno", hireDate: "2024-12-31", salary: 5775.00 },
            { id: "6", name: "Nathalia Carvalho", role: "Analista Júnior", hireDate: "2024-12-31", salary: 3780.00 },
            { id: "7", name: "Vitoria Damacena", role: "Analista Júnior", hireDate: "2024-12-31", salary: 3541.67 },
            { id: "8", name: "Julio Gracco", role: "Diretor de Comunicação & Branding", hireDate: "2024-12-31", salary: 38000.00 },
            { id: "9", name: "Pedro Souto", role: "Diretor de Marketing & Merchandising", hireDate: "2024-12-31", salary: 30000.00 },
            { id: "10", name: "Gabriel Assis", role: "Gerente de Branding", hireDate: "2024-12-31", salary: 15015.00 }
        ];

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        async function initializeFirebase() {
            const authStatusEl = document.getElementById('auth-status');
            const loadingMessage = document.getElementById('loading-message');
            const authTimeout = setTimeout(() => { loadingMessage.innerHTML = 'A conexão está demorando... <a href="#" onclick="location.reload()" class="underline">Tentar novamente</a>.'; }, 10000);

            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyAs9tsz3wsSjYlmbu8_7NnEbKxqsFV2ATo",
                    authDomain: "rvcomercial-fc7c9.firebaseapp.com",
                    projectId: "rvcomercial-fc7c9",
                    storageBucket: "rvcomercial-fc7c9.firebasestorage.app",
                    messagingSenderId: "373252435120",
                    appId: "1:373252435120:web:817b4e65f46a2a572adf75"
                };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                contractsCollection = collection(db, `artifacts/${appId}/public/data/contracts`);
                teamCollection = collection(db, `artifacts/${appId}/public/data/team`);

                onAuthStateChanged(auth, async (user) => {
                    clearTimeout(authTimeout);
                    if (user) {
                        state.userId = user.uid;
                        state.isAuthReady = true;
                        authStatusEl.textContent = `Status: Conectado`;
                        authStatusEl.className = "auth-success";
                        listenToData();
                    } else {
                        loadingMessage.textContent = 'Autenticando...';
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) await signInWithCustomToken(auth, token);
                        else await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-screen').innerHTML = `<p class="auth-fail">Erro fatal ao conectar ao Firebase.</p>`;
            }
        }
        
        function listenToData() {
            if (!state.isAuthReady) return;
            const appContainer = document.getElementById('app-container');
            const loadingScreen = document.getElementById('loading-screen');

            if (unsubscribeContracts) unsubscribeContracts();
            unsubscribeContracts = onSnapshot(contractsCollection, (snapshot) => {
                state.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContractsList();
                calculateAndRenderAll();
            }, (error) => console.error("Contract listener error:", error));

            if (unsubscribeTeam) unsubscribeTeam();
            unsubscribeTeam = onSnapshot(teamCollection, (snapshot) => {
                state.team = snapshot.docs.map(doc => ({ ...doc.data() }));
                state.isDataReady = true;
                loadingScreen.style.display = 'none';
                appContainer.style.display = 'grid'; // Use grid to match the layout
                renderTeamList();
                calculateAndRenderAll();
            }, (error) => console.error("Team listener error:", error));
        }

        async function populateInitialTeam() {
            const button = document.getElementById('populate-team-btn');
            button.textContent = 'Carregando...';
            button.disabled = true;
            const batch = writeBatch(db);
            initialTeamData.forEach(member => {
                const docRef = doc(teamCollection, member.id);
                batch.set(docRef, member);
            });
            try {
                await batch.commit();
            } catch (error) {
                console.error("Populate team error:", error);
                alert("Falha ao carregar a equipe. Verifique as permissões de escrita.");
                button.textContent = 'Carregar equipe padrão';
                button.disabled = false;
            }
        }

        function renderTeamList() {
            const teamContainer = document.getElementById('team-container');
            if (!teamContainer) return;
            if (state.isDataReady && state.team.length === 0) {
                teamContainer.innerHTML = `<div class="p-4 text-center"><p class="text-gray-600">Equipe não encontrada no banco de dados.</p><button id="populate-team-btn" class="btn btn-dark mt-2">Carregar equipe padrão</button></div>`;
                document.getElementById('populate-team-btn').addEventListener('click', populateInitialTeam);
                return;
            }
            teamContainer.innerHTML = `<table class="min-w-full">
                <thead class="table-header sticky top-0 bg-white"><tr><th class="px-4 py-3 text-left">Nome</th><th class="px-4 py-3 text-left">Cargo</th><th class="px-4 py-3 text-left">Salário</th></tr></thead>
                <tbody id="team-list-body"></tbody>
            </table>`;
            const teamListBody = document.getElementById('team-list-body');
            teamListBody.innerHTML = '';
            state.team.forEach(member => {
                teamListBody.innerHTML += `<tr class="table-row">
                    <td class="p-4 whitespace-nowrap"><div class="text-sm font-semibold">${member.name}</div><div class="text-xs text-gray-500">${new Date(member.hireDate) < new Date('2025-01-01') ? 'Elegível Pré-2025' : 'Não Elegível'}</div></td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-600">${member.role}</td>
                    <td class="p-4 whitespace-nowrap text-sm font-mono">${formatCurrency(member.salary)}</td>
                </tr>`;
            });
        }
        
        function renderContractsList() {
            const contractsListEl = document.getElementById('contracts-list');
            if(!contractsListEl) return;
            contractsListEl.innerHTML = '';
            state.contracts.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(contract => {
                contractsListEl.innerHTML += `<tr class="table-row">
                    <td class="p-4 whitespace-nowrap text-sm font-semibold">${contract.client}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-600 font-mono">${formatCurrency(contract.value)}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-600">${new Date(contract.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-center"><button onclick="window.deleteContract('${contract.id}')" class="text-gray-400 hover:text-red-500 transition-colors">✖</button></td>
                </tr>`;
            });
        }
        
        function getParameters() {
            return {
                percentages: {
                    pre2025: {1:parseFloat(document.getElementById('perc_pre2025_f1').value)/100||0, 2:parseFloat(document.getElementById('perc_pre2025_f2').value)/100||0, 3:parseFloat(document.getElementById('perc_pre2025_f3').value)/100||0},
                    from2025: {1:parseFloat(document.getElementById('perc_2025_f1').value)/100||0, 2:parseFloat(document.getElementById('perc_2025_f2').value)/100||0, 3:parseFloat(document.getElementById('perc_2025_f3').value)/100||0}
                },
                weights: { "Diretor Comercial": parseFloat(document.getElementById('peso_diretor').value)||0, "Diretor de Comunicação & Branding": parseFloat(document.getElementById('peso_diretor').value)||0, "Diretor de Marketing & Merchandising": parseFloat(document.getElementById('peso_diretor').value)||0, "Gerente Comercial": parseFloat(document.getElementById('peso_gerente').value)||0, "Gerente de Branding": parseFloat(document.getElementById('peso_gerente').value)||0, "Especialista": parseFloat(document.getElementById('peso_especialista').value)||0, "Designer Pleno": parseFloat(document.getElementById('peso_pleno').value)||0, "Analista Júnior": parseFloat(document.getElementById('peso_junior').value)||0 }
            };
        }

        function calculateAndRenderAll() {
            if (!state.isDataReady) return;
            const params = getParameters();
            const vgvPre2025 = state.contracts.filter(c => new Date(c.date) < new Date('2025-01-01')).reduce((sum, c) => sum + c.value, 0);
            const vgvFrom2025 = state.contracts.filter(c => new Date(c.date) >= new Date('2025-01-01')).reduce((sum, c) => sum + c.value, 0);
            let faixaPre2025 = 0; for (const t of state.targets.pre2025) { if (vgvPre2025 >= t.value) { faixaPre2025 = t.faixa; break; } }
            const percPre2025 = faixaPre2025 > 0 ? params.percentages.pre2025[faixaPre2025] : 0;
            let faixaFrom2025 = 0; for (const t of state.targets.from2025) { if (vgvFrom2025 >= t.value) { faixaFrom2025 = t.faixa; break; } }
            const percFrom2025 = faixaFrom2025 > 0 ? params.percentages.from2025[faixaFrom2025] : 0;
            const bonusPoolPre2025 = vgvPre2025 * percPre2025;
            const bonusPoolFrom2025 = vgvFrom2025 * percFrom2025;
            const teamEligiblePre2025 = state.team.filter(m => new Date(m.hireDate) < new Date('2025-01-01'));
            const totalWeightPre2025 = teamEligiblePre2025.reduce((sum, m) => sum + (params.weights[m.role] || 0), 0);
            const totalWeightFrom2025 = state.team.reduce((sum, m) => sum + (params.weights[m.role] || 0), 0);
            
            const resultsEl = document.getElementById('commission-results');
            resultsEl.innerHTML = '';
            state.team.sort((a,b) => (params.weights[b.role] || 0) - (params.weights[a.role] || 0)).forEach(member => {
                const weight = params.weights[member.role] || 0;
                const commissionPre2025 = (new Date(member.hireDate) < new Date('2025-01-01') && totalWeightPre2025 > 0) ? (weight / totalWeightPre2025) * bonusPoolPre2025 : 0;
                const commissionFrom2025 = totalWeightFrom2025 > 0 ? (weight / totalWeightFrom2025) * bonusPoolFrom2025 : 0;
                const totalCommission = commissionPre2025 + commissionFrom2025;
                const bonusInSalaries = member.salary > 0 ? totalCommission / member.salary : 0;
                resultsEl.innerHTML += `<tr class="table-row ${totalCommission > 0 ? 'highlight' : ''}"><td class="p-4"><div class="text-sm font-semibold">${member.name}</div><div class="text-xs text-gray-500">${member.role}</div></td><td class="p-4 text-sm text-gray-600 font-mono">${formatCurrency(commissionPre2025)}</td><td class="p-4 text-sm text-gray-600 font-mono">${formatCurrency(commissionFrom2025)}</td><td class="p-4 text-sm font-semibold font-mono">${formatCurrency(totalCommission)}</td><td class="p-4 text-sm font-semibold text-blue-600">${bonusInSalaries.toFixed(2)}x</td></tr>`;
            });
            document.getElementById('vgv-pre2025').textContent = formatCurrency(vgvPre2025);
            document.getElementById('faixa-pre2025').textContent = faixaPre2025 > 0 ? `Faixa ${faixaPre2025}` : 'Nenhuma';
            document.getElementById('bonus-pre2025').textContent = formatCurrency(bonusPoolPre2025);
            document.getElementById('vgv-2025').textContent = formatCurrency(vgvFrom2025);
            document.getElementById('faixa-2025').textContent = faixaFrom2025 > 0 ? `Faixa ${faixaFrom2025}` : 'Nenhuma';
            document.getElementById('bonus-2025').textContent = formatCurrency(bonusPoolFrom2025);
        }
        
        async function addContract(contractData) { try { await addDoc(contractsCollection, contractData); } catch (e) { console.error(e); alert("Falha ao salvar contrato."); } }
        async function deleteContract(contractId) { if (!confirm("Excluir este contrato?")) return; try { await deleteDoc(doc(db, contractsCollection.path, contractId)); } catch (e) { console.error(e); alert("Falha ao excluir contrato."); } }
        window.deleteContract = deleteContract;

        document.getElementById('contract-form').addEventListener('submit', function(e) { e.preventDefault(); addContract({client: document.getElementById('contract-client').value, value: parseFloat(document.getElementById('contract-value').value), date: document.getElementById('contract-date').value }); this.reset(); });
        document.getElementById('import-csv-btn').addEventListener('click', () => { const fileInput = document.getElementById('csv-file'); if(fileInput.files[0]) importContractsFromCSV(fileInput.files[0]); else alert("Selecione um arquivo CSV."); });
        document.querySelectorAll('.panel input[type=number]').forEach(input => input.addEventListener('change', calculateAndRenderAll));
        
        async function importContractsFromCSV(file) {
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csv = event.target.result; const lines = csv.split(/\r\n|\n/).filter(l => l.trim() !== '');
                const batch = writeBatch(db);
                lines.forEach(line => {
                    const parts = line.split(',');
                    if (parts.length < 3) return;
                    const contract = { client: parts[0].trim(), value: parseFloat(parts[1]), date: parts[2].trim() };
                    if(contract.client && !isNaN(contract.value) && contract.date) { batch.set(doc(contractsCollection), contract); }
                });
                try { await batch.commit(); alert(`${lines.length} contratos importados com sucesso!`); } catch (e) { console.error("CSV import error:", e); alert("Erro na importação."); }
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
