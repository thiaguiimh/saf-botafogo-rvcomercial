<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suíte de Comissões</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-blue: #007bff;
            --border-color: #dee2e6;
            --sidebar-bg: #343a40;
            --sidebar-text: #adb5bd;
            --sidebar-text-hover: #ffffff;
            --sidebar-active-bg: #495057;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-primary); }
        .card { background: var(--card-background); border-radius: 0.75rem; border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;}
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0069d9; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger-sm { background-color: #dc3545; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem;}
        .btn-edit-sm { background-color: #6c757d; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem;}
        .form-input { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid #ced4da; border-radius: 0.375rem; background-color: #fff; }
        .table-container { max-height: 500px; overflow: auto; border: 1px solid var(--border-color); border-radius: 0.5rem;}
        .table thead th { text-align: left; padding: 0.75rem 1rem; font-weight: 600; background-color: #f1f5f9; position: sticky; top: 0; font-size: 0.8rem; border-bottom: 2px solid var(--border-color); white-space: nowrap; }
        .table tbody td { padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .table tbody tr:last-child td { border-bottom: none; }
        .table-editable tbody td { padding: 0.25rem; }
        .table-editable input { width: 100%; padding: 0.5rem; border: 1px solid transparent; border-radius: 0.25rem; }
        .table-editable input:hover { border-color: #cbd5e1; }
        .table-editable input:focus { border-color: var(--accent-blue); outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loader-sm { width: 16px; height: 16px; border-width: 2px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- App Setup ---
            const appEl = document.getElementById('app');

            const fallbackFirebaseConfig = {
                apiKey: "AIzaSyAs9tsz3wsSjYlmbu8_7NnEbKxqsFV2ATo",
                authDomain: "rvcomercial-fc7c9.firebaseapp.com",
                projectId: "rvcomercial-fc7c9",
                storageBucket: "rvcomercial-fc7c9.appspot.com",
                messagingSenderId: "373252435120",
                appId: "1:373252435120:web:817b4e65f46a2a572adf75"
            };

            const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}')
                ? JSON.parse(__firebase_config)
                : fallbackFirebaseConfig;
            
            const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
            const auth = getAuth(app);
            const db = getFirestore(app);

            let state = {
                currentUser: null, userProfile: null, employees: [], contracts: [], commissionModels: [], users: [], settings: {}, jobTitles: [],
                currentView: 'loading', 
                adminView: 'dashboard', 
                adminAction: 'list',
                selectedItemId: null,
                loadingMessage: 'Inicializando...', unsubscribe: [],
                dataErrors: {},
            };

            // --- Collections ---
            const usersCol = collection(db, "users");
            const employeesCol = collection(db, "employees");
            const contractsCol = collection(db, "contracts");
            const commissionModelsCol = collection(db, "commissionModels");
            const jobTitlesCol = collection(db, "jobTitles");
            const settingsDocRef = doc(db, "settings", "global");

            // --- Helper Functions ---
            const formatCurrency = (v, compact = false) => {
                if (compact) {
                    return new Intl.NumberFormat('pt-BR', { notation: 'compact', compactDisplay: 'short' }).format(v || 0);
                }
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0);
            }
            const formatDate = (d) => d && d.seconds ? new Date(d.seconds * 1000).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A';
            const formatPercent = (v) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 3, maximumFractionDigits: 3 }).format(v || 0);
            
            // --- Data Sorting ---
            function getSortedEmployees() {
                const sortedTitles = [...state.jobTitles].sort((a, b) => a.order - b.order);
                const roleOrderMap = sortedTitles.reduce((acc, title, index) => {
                    acc[title.name] = index;
                    return acc;
                }, {});
                return [...state.employees].sort((a, b) => {
                    const orderA = roleOrderMap[a.roleTitle] ?? Infinity;
                    const orderB = roleOrderMap[b.roleTitle] ?? Infinity;
                    return orderA - orderB;
                });
            }

            // --- Authentication & Data Loading ---
            onAuthStateChanged(auth, async (user) => {
                state.unsubscribe.forEach(unsub => unsub());
                 state = { ...state, currentUser: user, userProfile: null, employees: [], contracts: [], commissionModels: [], users:[], settings: {}, jobTitles: [], unsubscribe: [], dataErrors: {} };

                if (user && !user.isAnonymous) {
                    state.loadingMessage = 'Carregando perfil do usuário...';
                    state.currentView = 'loading';
                    render();
                    try {
                        const userDocSnap = await getDoc(doc(db, "users", user.uid));
                        if (userDocSnap.exists()) {
                            state.userProfile = { id: user.uid, ...userDocSnap.data() };
                            initializeDataListeners();
                        } else { throw new Error("Perfil de usuário não encontrado. Contate o administrador."); }
                    } catch (error) {
                        alert(error.message);
                        await signOut(auth);
                    }
                } else {
                    state.currentView = 'login';
                    render();
                }
            });

            function initializeDataListeners() {
                let loadedCount = 0;
                const collectionsToLoad = state.userProfile?.isAdmin ? ['users', 'employees', 'contracts', 'commissionModels', 'settings', 'jobTitles'] : ['employees', 'contracts', 'commissionModels', 'settings', 'jobTitles'];

                const onDataLoaded = () => {
                    loadedCount++;
                    if (loadedCount >= collectionsToLoad.length) {
                        if (state.userProfile.isAdmin) {
                            state.currentView = 'admin';
                            parseHash();
                        } else {
                            state.currentView = 'employee';
                        }
                        render();
                    }
                };
                
                async function seedJobTitles() {
                    const defaultTitles = [
                        { name: "Diretor Comercial", order: 1 }, { name: "Gerente Comercial", order: 2 },
                        { name: "Especialista/Coordenador", order: 3 }, { name: "Designer Sênior", order: 4 },
                        { name: "Designer Pleno", order: 5 }, { name: "Designer Júnior", order: 6 },
                        { name: "Analista Sênior", order: 7 }, { name: "Analista Pleno", order: 8 },
                        { name: "Analista Júnior", order: 9 },
                    ];
                    const batch = writeBatch(db);
                    defaultTitles.forEach(title => { batch.set(doc(jobTitlesCol), title); });
                    try { await batch.commit(); } catch (error) { console.error("Error seeding job titles:", error); }
                }

                collectionsToLoad.forEach(key => {
                    state.loadingMessage = `Carregando ${key}...`;
                    if(appEl.innerHTML.includes('loader')) render();
                    
                    let ref;
                    if (key === 'settings') ref = settingsDocRef;
                    else ref = collection(db, key);

                    const unsub = onSnapshot(ref, async (snapshot) => {
                        delete state.dataErrors[key];
                        if (key === 'settings') {
                            state.settings = snapshot.exists() ? snapshot.data() : {};
                        } else if (key === 'jobTitles') {
                            if (snapshot.empty && state.userProfile.isAdmin) await seedJobTitles();
                            else state[key] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        } else {
                            state[key] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        }
                        onDataLoaded();
                    }, error => {
                        console.error(`Error listening to ${key}:`, error);
                        state.dataErrors[key] = error;
                        onDataLoaded();
                    });
                    state.unsubscribe.push(unsub);
                });
            }
            
            // --- Rendering Engine ---
            function render() {
                const viewRenderers = {
                    loading: () => `<div class="flex flex-col items-center justify-center h-screen"><div class="loader"></div><p class="mt-4 text-lg text-gray-600">${state.loadingMessage}</p></div>`,
                    login: renderLogin,
                    admin: renderAdminDashboard,
                    employee: renderEmployeeDashboard,
                };
                appEl.innerHTML = (viewRenderers[state.currentView] || viewRenderers.login)();
                attachEventListeners();
            }

            // --- Views ---
            function renderHeader(title) {
                return `<header class="bg-white shadow-sm border-b p-4 sticky top-0 z-40">
                    <div class="container mx-auto flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">Olá, ${state.userProfile?.name || ''}</span>
                            <button id="logoutBtn" class="btn btn-primary text-sm">Sair</button>
                        </div>
                    </div>
                </header>`;
            }
            
            function renderLogin() { return `<div class="flex items-center justify-center min-h-screen bg-gray-100"><div class="card w-full max-w-md shadow-lg"><h1 class="text-2xl font-bold text-center mb-2">Suíte de Comissões</h1><p class="text-center text-gray-500 mb-6">Acesse com suas credenciais.</p><form id="loginForm" class="space-y-4"><input id="email" type="email" placeholder="Email" class="form-input" required><input id="password" type="password" placeholder="Senha" class="form-input" required><button type="submit" class="btn btn-primary w-full !py-3 !text-base">Entrar</button></form></div></div>`; }

            function renderAdminDashboard() {
                const navItems = [
                    { key: 'dashboard', label: 'Dashboard' }, { key: 'analysis', label: 'Análise' },
                    { key: 'users', label: 'Usuários' }, { key: 'jobTitles', label: 'Cargos' }, 
                    { key: 'employees', label: 'Funcionários' }, { key: 'contracts', label: 'Contratos' }, 
                    { key: 'commissionModels', label: 'Modelos de Comissão' }
                ];
                const adminNav = navItems.map(item => `<a href="#" class="block px-4 py-2 rounded-md text-sm font-medium ${state.adminView === item.key ? 'bg-[var(--sidebar-active-bg)] text-white' : 'text-[var(--sidebar-text)] hover:bg-[var(--sidebar-active-bg)] hover:text-white'}" data-view="${item.key}">${item.label}</a>`).join('');
                
                const mainContentRenderers = {
                    dashboard: renderAdminMainDashboard,
                    analysis: renderAnalysisDashboard,
                    users: () => renderListPage('Usuários', renderAdminUserTable(), 'user'),
                    employees: () => renderListPage('Funcionários', renderAdminEmployeeTable(), 'employee'),
                    contracts: () => renderListPage('Contratos', renderAdminContractTable(), 'contract'),
                    commissionModels: () => renderListPage('Modelos de Comissão', renderAdminCommissionModelList(), 'commissionModel'),
                    jobTitles: () => renderListPage('Cargos', renderAdminJobTitleTable(), 'jobTitle'),
                };
                
                const formContentRenderers = {
                    user: (item) => renderFormPage('Usuário', renderAdminUserForm(item), 'user'),
                    employee: (item) => renderFormPage('Funcionário', renderAdminEmployeeForm(item), 'employee'),
                    contract: (item) => renderFormPage('Contrato', renderAdminContractForm(item), 'contract'),
                    commissionModel: (item) => renderFormPage('Modelo de Comissão', renderAdminCommissionModelForm(item), 'commissionModel'),
                    jobTitle: (item) => renderFormPage('Cargo', renderAdminJobTitleForm(item), 'jobTitle'),
                };

                let contentHtml;
                if (state.adminAction === 'form') {
                    const typeKey = state.adminView.endsWith('s') ? state.adminView : state.adminView + 's';
                    const item = state.selectedItemId ? state[typeKey].find(i => i.id === state.selectedItemId) : {};
                    const singularType = state.adminView.endsWith('s') ? state.adminView.slice(0, -1) : state.adminView;
                    contentHtml = formContentRenderers[singularType](item);
                } else {
                    contentHtml = (mainContentRenderers[state.adminView] || mainContentRenderers.dashboard)();
                }

                return `${renderHeader('Painel Administrativo')}
                    <div class="flex">
                        <aside class="w-64 bg-[var(--sidebar-bg)] p-4 h-[calc(100vh-81px)] sticky top-[81px] overflow-y-auto">
                            <nav class="space-y-1">${adminNav}</nav>
                        </aside>
                        <main class="flex-1 p-6 bg-gray-50">${contentHtml}</main>
                    </div>`;
            }

            // --- PAGE RENDERERS (List & Form) ---
            function renderListPage(title, tableHtml, type) {
                return `<div class="card"><div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">${title}</h2>
                    <button class="btn-add-item text-sm btn btn-primary" data-type="${type}">Adicionar</button>
                </div><div>${tableHtml}</div></div>`;
            }
            
            function renderFormPage(title, formHtml, type) {
                 return `<div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">${state.selectedItemId ? 'Editar' : 'Adicionar'} ${title}</h2>
                        <button class="btn-back text-sm btn" data-type="${type}">Voltar para a Lista</button>
                    </div>
                    <div>${formHtml}</div>
                </div>`;
            }

            function renderAdminMainDashboard() {
                const activeModelId = state.settings?.activeCommissionModelId;
                const activeModel = state.commissionModels.find(m => m.id === activeModelId);

                let totalCommissions = 0;
                if (activeModel && activeModel.tiers) {
                    state.contracts.forEach(contract => {
                        const tier = activeModel.tiers.find(t => contract.value >= t.rangeInf && (t.rangeSup === null || contract.value <= t.rangeSup));
                        if (tier && contract.participants) {
                            contract.participants.forEach(employeeId => {
                                if(tier.rates && tier.rates[employeeId]) {
                                    totalCommissions += contract.value * tier.rates[employeeId];
                                }
                            });
                        }
                    });
                }
                const totalRevenue = state.contracts.reduce((acc, c) => acc + (c.value || 0), 0);
                const effectiveRate = totalRevenue > 0 ? totalCommissions / totalRevenue : 0;
                
                const settingsCard = `<div class="card">
                    <h3 class="text-lg font-semibold mb-4">Configurações Gerais</h3>
                    <div class="flex items-center gap-4">
                        <label for="activeModelSelect" class="font-medium">Modelo de Comissão Ativo para Cálculos:</label>
                        <select id="activeModelSelect" class="form-input w-64">
                            <option value="">Nenhum</option>
                            ${state.commissionModels.map(m => `<option value="${m.id}" ${m.id === activeModelId ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                        <button id="saveSettingsBtn" class="btn btn-primary">Salvar</button>
                    </div>
                    ${!activeModelId ? `<p class="text-sm text-orange-600 mt-2">Atenção: Nenhum modelo de comissão está ativo. Os cálculos de bônus não serão realizados.</p>`: ''}
                </div>`;

                 const kpiCards = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card !p-4"><div class="text-sm text-gray-500">Receita Total de Contratos</div><div class="text-3xl font-bold">${formatCurrency(totalRevenue)}</div></div>
                        <div class="card !p-4"><div class="text-sm text-gray-500">Total de Comissões (Modelo Ativo)</div><div class="text-3xl font-bold">${formatCurrency(totalCommissions)}</div></div>
                        <div class="card !p-4"><div class="text-sm text-gray-500">Taxa Efetiva (Modelo Ativo)</div><div class="text-3xl font-bold">${formatPercent(effectiveRate)}</div></div>
                    </div>`;
                
                return `<div>${settingsCard}${kpiCards}</div>`;
            }
            
            // --- Analysis Dashboard ---
            function renderAnalysisDashboard() {
                // Chart 1: Revenue by Commercial Property
                const salesByProperty = state.contracts.reduce((acc, c) => {
                    const prop = c.commercialProperty || 'Não especificado';
                    acc[prop] = (acc[prop] || 0) + (c.value || 0);
                    return acc;
                }, {});
                const maxPropValue = Math.max(...Object.values(salesByProperty), 1);
                const propertyChart = `
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Receita por Propriedade Comercial</h3>
                        <div class="space-y-4">
                            ${Object.keys(salesByProperty).length > 0 ? Object.entries(salesByProperty).map(([prop, val]) => `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-medium">${prop}</span>
                                        <span>${formatCurrency(val)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full" style="width: ${(val / maxPropValue) * 100}%"></div></div>
                                </div>`).join('') : '<p class="text-gray-500">Nenhum contrato cadastrado.</p>'}
                        </div>
                    </div>`;

                // Chart 2: Contracts by Value Range
                const valueRanges = [
                    { label: 'Até 1M', min: 0, max: 1000000 }, { label: '1M - 5M', min: 1000001, max: 5000000 },
                    { label: '5M - 10M', min: 5000001, max: 10000000 }, { label: 'Acima de 10M', min: 10000001, max: Infinity }
                ];
                const contractsByRange = valueRanges.map(range => ({
                    ...range,
                    count: state.contracts.filter(c => c.value >= range.min && c.value <= range.max).length
                }));
                const maxContractsInRange = Math.max(...contractsByRange.map(r => r.count), 1);
                const rangeChart = `
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Contratos por Faixa de Valor</h3>
                        <div class="space-y-4">
                             ${contractsByRange.map(range => `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-medium">${range.label}</span>
                                        <span>${range.count} contrato(s)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-green-500 h-4 rounded-full" style="width: ${(range.count / maxContractsInRange) * 100}%"></div></div>
                                </div>`).join('')}
                        </div>
                    </div>`;

                return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${propertyChart}${rangeChart}</div>
                        ${renderSensitivityMatrix()}`;
            }
            
            function renderSensitivityMatrix() {
                const activeModel = state.commissionModels.find(m => m.id === state.settings.activeCommissionModelId);
                 if (!activeModel) return '<div class="card text-center"><p class="text-orange-500">Selecione um Modelo de Comissão ativo no Dashboard para ver a análise de sensibilidade.</p></div>';

                const currentRevenue = state.contracts.reduce((sum, c) => sum + c.value, 0);
                if (currentRevenue === 0) return '<div class="card text-center"><p>Adicione contratos para calcular a matriz de sensibilidade.</p></div>';
                
                // --- Calculation Logic ---
                const contractMix = state.contracts.reduce((acc, contract) => {
                    const valueKey = contract.value.toString();
                    if (!acc[valueKey]) {
                        acc[valueKey] = { count: 0, contract: contract };
                    }
                    acc[valueKey].count++;
                    return acc;
                }, {});

                const projections = [];
                for (let i = -50; i <= 100; i += 25) {
                    const projectedRevenue = currentRevenue * (1 + i / 100);
                    const growthFactor = projectedRevenue / currentRevenue;
                    
                    const projectedBonuses = {};
                    getSortedEmployees().forEach(emp => { projectedBonuses[emp.id] = 0; });

                    Object.values(contractMix).forEach(mix => {
                        const projectedCount = mix.count * growthFactor;
                        const tier = activeModel.tiers.find(t => mix.contract.value >= t.rangeInf && (t.rangeSup === null || mix.contract.value <= t.rangeSup));
                        if (tier) {
                            (mix.contract.participants || []).forEach(employeeId => {
                                if (tier.rates && tier.rates[employeeId]) {
                                    projectedBonuses[employeeId] += mix.contract.value * tier.rates[employeeId] * projectedCount;
                                }
                            });
                        }
                    });

                    projections.push({ revenue: projectedRevenue, bonuses: projectedBonuses });
                }
                
                // --- Rendering Logic ---
                const sortedEmployees = getSortedEmployees();
                const headers = ['Receita Projetada', ...sortedEmployees.map(e => e.name)];
                const headerHtml = `<thead><tr>${headers.map(h => `<th class="text-center">${h}</th>`).join('')}</tr></thead>`;
                
                let maxSalaries = 0;
                const rowsData = projections.map(p => {
                    const employeeSalaries = {};
                    sortedEmployees.forEach(emp => {
                        const salaryCount = emp.salary > 0 ? p.bonuses[emp.id] / emp.salary : 0;
                        employeeSalaries[emp.id] = salaryCount;
                        if(salaryCount > maxSalaries) maxSalaries = salaryCount;
                    });
                    return { revenue: p.revenue, salaries: employeeSalaries };
                });

                const bodyHtml = `<tbody>${rowsData.map(row => {
                    return `<tr>
                        <td class="font-semibold text-center">${formatCurrency(row.revenue, true)}</td>
                        ${sortedEmployees.map(emp => {
                            const salaryCount = row.salaries[emp.id];
                            const colorIntensity = maxSalaries > 0 ? (salaryCount / maxSalaries) : 0;
                            // Interpolate lightness from 95% (light blue) to 30% (dark blue)
                            const lightness = 95 - (colorIntensity * 65);
                            const bgColor = `hsl(210, 100%, ${lightness}%)`;
                            return `<td class="text-center" style="background-color: ${bgColor}; color: ${lightness < 60 ? 'white' : 'black'}">
                                ${salaryCount.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})}x
                            </td>`;
                        }).join('')}
                    </tr>`;
                }).join('')}</tbody>`;

                return `<div class="card mt-6">
                    <h3 class="text-lg font-semibold mb-4">Matriz de Sensibilidade: Receita vs. Bônus (em nº de salários)</h3>
                    <div class="table-container">${'<table class="w-full text-sm table">'}${headerHtml}${bodyHtml}</table></div>
                </div>`;
            }

            // --- ADMIN LIST RENDERERS ---
            function renderAdminUserTable() {
                if(state.dataErrors.users) return renderErrorCard('Usuários', state.dataErrors.users);
                return `<table class="w-full text-sm table"><tbody>${state.users.map(u => `<tr><td><div class="font-semibold">${u.name}</div><div class="text-xs text-gray-500">${u.email} | ${u.isAdmin ? 'Admin' : ''} ${u.isManager ? 'Gestor' : ''}</div></td><td class="text-right space-x-2"><button class="btn-edit-item btn-edit-sm" data-type="user" data-id="${u.id}">Editar</button></td></tr>`).join('')}</tbody></table>`;
            }

            function renderAdminEmployeeTable() {
                if(state.dataErrors.employees) return renderErrorCard('Funcionários', state.dataErrors.employees);
                const sortedEmployees = getSortedEmployees();
                const headers = ['Nome', 'Cargo', 'Salário', 'Data de Admissão', 'Ações'];
                const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
                const bodyHtml = `<tbody>${sortedEmployees.map(e => `
                    <tr>
                        <td><div class="font-semibold">${e.name}</div></td>
                        <td>${e.roleTitle || 'N/A'}</td>
                        <td>${formatCurrency(e.salary)}</td>
                        <td>${formatDate(e.admissionDate)}</td>
                        <td class="text-right space-x-2">
                            <button class="btn-edit-item btn-edit-sm" data-type="employee" data-id="${e.id}">Editar</button>
                            <button class="btn-danger-sm" data-type="employee" data-id="${e.id}">×</button>
                        </td>
                    </tr>
                `).join('')}</tbody>`;

                return `<div class="table-container"><table class="w-full text-sm table">${headerHtml}${bodyHtml}</table></div>`;
            }

            function renderAdminContractTable() {
                if(state.dataErrors.contracts) return renderErrorCard('Contratos', state.dataErrors.contracts);
                return `<table class="w-full text-sm table"><thead><th>Empresa / Propriedade</th><th>Valor</th><th>Data</th><th>Ações</th></thead><tbody>${state.contracts.map(c => `<tr><td><div class="font-semibold">${c.companyName}</div><div class="text-xs text-gray-500">${c.commercialProperty}</div></td><td>${formatCurrency(c.value)}</td><td>${formatDate(c.closingDate)}</td><td class="text-right space-x-2"><button class="btn-edit-item btn-edit-sm" data-type="contract" data-id="${c.id}">Editar</button><button class="btn-danger-sm" data-type="contract" data-id="${c.id}">×</button></td></tr>`).join('')}</tbody></table>`;
            }
            
             function renderAdminJobTitleTable() {
                if (state.dataErrors.jobTitles) return renderErrorCard('Cargos', state.dataErrors.jobTitles);
                const sortedTitles = [...state.jobTitles].sort((a, b) => a.order - b.order);
                const headers = ['Nome do Cargo', 'Ordem', 'Ações'];
                const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
                const bodyHtml = `<tbody>${sortedTitles.map(t => `
                    <tr>
                        <td><div class="font-semibold">${t.name}</div></td>
                        <td>${t.order}</td>
                        <td class="text-right space-x-2">
                            <button class="btn-edit-item btn-edit-sm" data-type="jobTitle" data-id="${t.id}">Editar</button>
                            <button class="btn-danger-sm" data-type="jobTitle" data-id="${t.id}">×</button>
                        </td>
                    </tr>
                `).join('')}</tbody>`;
                return `<div class="table-container"><table class="w-full text-sm table">${headerHtml}${bodyHtml}</table></div>`;
            }

            function renderAdminCommissionModelList() {
                if (state.dataErrors.commissionModels) return renderErrorCard('Modelos de Comissão', state.dataErrors.commissionModels);
                if (state.commissionModels.length === 0) return '<p>Nenhum modelo de comissão cadastrado.</p>';

                return state.commissionModels.map(model => {
                    return `<div class="mb-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">${model.name}</h3>
                            <div class="space-x-2">
                                <button class="btn-edit-item btn-edit-sm" data-type="commissionModel" data-id="${model.id}">Editar Modelo</button>
                                <button class="btn-danger-sm" data-type="commissionModel" data-id="${model.id}">×</button>
                            </div>
                        </div>
                        ${renderCommissionModelTable(model, false)}
                    </div>`;
                }).join('');
            }

            function renderCommissionModelTable(model, isEditable) {
                if (!model || !model.tiers) return '<p class="text-gray-500">Este modelo não possui faixas definidas.</p>';
                const employees = getSortedEmployees();
                const headers = ['Faixa', 'Range Inf', 'Range Sup', ...employees.map(e => e.name)];
                
                const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}${isEditable ? '<th>Ações</th>' : ''}</tr></thead>`;
                
                const bodyHtml = `<tbody>${model.tiers.map((tier, index) => {
                    const rowId = `tier-row-${index}`;
                    let cells;
                    if (isEditable) {
                        cells = `
                            <td><input type="text" class="form-input bg-gray-100" value="Faixa ${index + 1}" disabled></td>
                            <td><input type="number" step="0.01" name="rangeInf" class="form-input" value="${tier.rangeInf || 0}"></td>
                            <td><input type="number" step="0.01" name="rangeSup" class="form-input" placeholder="em branco para infinito" value="${tier.rangeSup || ''}"></td>
                            ${employees.map(e => `<td><input type="number" step="0.001" name="rate_${e.id}" class="form-input" value="${(tier.rates?.[e.id] || 0) * 100}"></td>`).join('')}
                            <td><button type="button" class="btn-danger-sm remove-tier-btn" data-row-id="${rowId}">×</button></td>
                        `;
                    } else {
                         cells = `
                            <td>Faixa ${index + 1}</td>
                            <td>${formatCurrency(tier.rangeInf)}</td>
                            <td>${tier.rangeSup ? formatCurrency(tier.rangeSup) : 'Acima'}</td>
                            ${employees.map(e => `<td>${formatPercent(tier.rates?.[e.id] || 0)}</td>`).join('')}
                         `;
                    }
                    return `<tr id="${rowId}">${cells}</tr>`;
                }).join('')}</tbody>`;

                return `<div class="table-container"><table class="w-full text-sm table ${isEditable ? 'table-editable': ''}">${headerHtml}${bodyHtml}</table></div>`;
            }

            function renderErrorCard(collectionName, error) { return `<div class="p-4 text-red-700 bg-red-100 border border-red-400 rounded"><strong>Erro ao carregar ${collectionName}.</strong><p class="text-sm mt-1">Verifique as permissões de leitura da coleção "${collectionName.toLowerCase()}" no seu console do Firebase e atualize a página.</p><p class="text-xs mt-2 font-mono bg-red-50 p-1 rounded">Detalhes: ${error.message}</p></div>`;}
            
            // --- ADMIN FORM RENDERERS ---
            function renderAdminUserForm(item = {}) { return `<form class="space-y-4" data-id="${item.id || ''}"><input name="name" placeholder="Nome Completo" class="form-input text-sm" value="${item.name || ''}" required><input name="email" type="email" placeholder="Email (para login)" class="form-input text-sm" value="${item.email || ''}" required ${item.id ? 'disabled' : ''}>${!item.id ? `<input name="password" type="password" placeholder="Senha (mínimo 6 caracteres)" class="form-input text-sm" required>` : ''}<div class="flex gap-4"><label class="text-sm flex items-center gap-2"><input type="checkbox" name="isManager" ${item.isManager ? 'checked' : ''}> Gestor</label><label class="text-sm flex items-center gap-2"><input type="checkbox" name="isAdmin" ${item.isAdmin ? 'checked' : ''}> Admin</label></div><button type="submit" class="btn btn-primary text-sm w-full !py-2">Salvar Usuário</button></form>`;}
            
            function renderAdminEmployeeForm(item = {}) {
                const admissionDate = item.admissionDate?.seconds ? new Date(item.admissionDate.seconds * 1000).toISOString().split('T')[0] : '';
                const sortedTitles = [...state.jobTitles].sort((a, b) => a.order - b.order);

                return `<form class="space-y-4" data-id="${item.id || ''}">
                    <input name="name" placeholder="Nome do Funcionário" class="form-input text-sm" value="${item.name || ''}" required>
                    
                    <div>
                        <label class="text-xs">Cargo</label>
                        <select name="roleTitle" class="form-input text-sm" required>
                            <option value="">Selecione um cargo</option>
                            ${sortedTitles.map(t => `<option value="${t.name}" ${item.roleTitle === t.name ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>

                    <input name="salary" type="number" step="0.01" placeholder="Salário" class="form-input text-sm" value="${item.salary || ''}" required>
                    <label class="text-xs">Data de Admissão</label>
                    <input name="admissionDate" type="date" class="form-input text-sm" value="${admissionDate}" required>
                    <button type="submit" class="btn btn-primary text-sm w-full !py-2">Salvar Funcionário</button>
                </form>`;
            }

            function renderAdminContractForm(item = {}) {
                const closingDate = item.closingDate?.seconds ? new Date(item.closingDate.seconds * 1000).toISOString().split('T')[0] : '';
                return `<form class="space-y-4" data-id="${item.id || ''}">
                    <input name="companyName" placeholder="Nome da Empresa" class="form-input text-sm" value="${item.companyName || ''}" required>
                    <input name="commercialProperty" placeholder="Propriedade Comercial (Ex: Naming Rights)" class="form-input text-sm" value="${item.commercialProperty || ''}" required>
                    <input name="value" type="number" step="0.01" placeholder="Valor do Contrato" class="form-input text-sm" value="${item.value || ''}" required>
                    <label class="text-xs">Data de Fechamento</label>
                    <input name="closingDate" type="date" class="form-input text-sm" value="${closingDate}" required>
                    <div class="text-sm font-medium">Participantes do Contrato:</div>
                    <div><label class="flex items-center text-xs gap-2 mb-2 font-medium"><input type="checkbox" id="selectAllParticipants"> Selecionar Todos</label></div>
                    <div id="participants-container" class="max-h-32 overflow-y-auto p-2 border rounded-md grid grid-cols-2 gap-2">
                        ${getSortedEmployees().map(e => `<label class="flex items-center text-xs gap-2"><input type="checkbox" name="participants" value="${e.id}" ${item.participants?.includes(e.id) ? 'checked' : ''}>${e.name}</label>`).join('')}
                    </div>
                    <button type="submit" class="btn btn-primary text-sm w-full !py-2 mt-4">Salvar Contrato</button>
                </form>`;
            }
            
            function renderAdminJobTitleForm(item = {}) {
                return `<form class="space-y-4" data-id="${item.id || ''}">
                    <input name="name" placeholder="Nome do Cargo" class="form-input text-sm" value="${item.name || ''}" required>
                    <input name="order" type="number" placeholder="Ordem de Exibição (Ex: 1)" class="form-input text-sm" value="${item.order || ''}" required>
                    <button type="submit" class="btn btn-primary text-sm w-full !py-2">Salvar Cargo</button>
                </form>`;
            }

            function renderAdminCommissionModelForm(item = {}) {
                const modelData = item.id ? item : { name: '', tiers: [{ rangeInf: 0, rangeSup: null, rates: {} }] };
                return `<form data-id="${modelData.id || ''}">
                    <input name="name" placeholder="Nome do Modelo (Ex: Modelo Comercial 2024)" class="form-input text-sm mb-4" value="${modelData.name || ''}" required>
                    <div id="tiers-table-container">${renderCommissionModelTable(modelData, true)}</div>
                    <div class="flex justify-between mt-4">
                       <button type="button" id="addTierBtn" class="text-sm text-blue-600 hover:underline">+ Adicionar Faixa</button>
                       <button type="submit" class="btn btn-primary text-sm w-auto !py-2">Salvar Modelo</button>
                    </div>
                </form>`;
            }
            
            // --- Employee View ---
            function renderEmployeeDashboard() {
                let content = '';
                if (state.dataErrors.commissionModels || state.dataErrors.contracts || state.dataErrors.employees) {
                    content = `<div class="card text-center"><p class="text-red-600 font-semibold">Não foi possível carregar os dados necessários.</p><p class="text-sm mt-2">Contate um administrador.</p></div>`;
                    return `${renderHeader('Dashboard de Comissões')}<main class="p-6">${content}</main>`;
                }

                const employeeProfile = state.employees.find(emp => emp.name === state.userProfile.name);
                if (!employeeProfile) {
                    content = `<div class="card text-center"><p class="text-red-500">Seu perfil de funcionário não foi encontrado.</p></div>`;
                } else {
                    const myContracts = state.contracts.filter(c => c.participants?.includes(employeeProfile.id));
                    const activeModel = state.commissionModels.find(m => m.id === state.settings.activeCommissionModelId);
                    let totalBonus = 0;

                    if (!activeModel || !activeModel.tiers) {
                        content = `<div class="card text-center"><p class="text-orange-500">Nenhum modelo de comissão ativo foi configurado no sistema.</p></div>`;
                    } else {
                        const commissionRows = myContracts.map(contract => {
                            const tier = activeModel.tiers.find(t => contract.value >= t.rangeInf && (t.rangeSup === null || contract.value <= t.rangeSup));
                            const myRate = tier && tier.rates ? (tier.rates[employeeProfile.id] || 0) : 0;
                            const myBonus = contract.value * myRate;
                            totalBonus += myBonus;
                            return `<tr>
                                <td><div class="font-semibold">${contract.companyName}</div><div class="text-xs text-gray-500">${contract.commercialProperty}</div></td>
                                <td>${formatCurrency(contract.value)}</td>
                                <td>${tier ? `Faixa (${formatCurrency(tier.rangeInf)} - ${tier.rangeSup ? formatCurrency(tier.rangeSup) : 'Acima'})` : 'Fora da faixa'}</td>
                                <td>${formatPercent(myRate)}</td>
                                <td class="font-semibold">${formatCurrency(myBonus)}</td>
                            </tr>`;
                        }).join('');

                        content = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="card !p-4"><div class="text-sm text-gray-500">Seu Bônus Total (Modelo: ${activeModel.name})</div><div class="text-3xl font-bold">${formatCurrency(totalBonus)}</div></div><div class="card !p-4"><div class="text-sm text-gray-500">Contratos Participados</div><div class="text-3xl font-bold">${myContracts.length}</div></div></div><div class="card"><h2 class="text-xl font-semibold mb-4">Detalhamento de Comissões</h2><div class="table-container"><table class="w-full text-sm table"><thead><tr><th>Contrato</th><th>Valor Total</th><th>Faixa de Comissão</th><th>Sua Taxa</th><th>Seu Bônus</th></tr></thead><tbody>${commissionRows.length ? commissionRows : '<tr><td colspan="5" class="text-center text-gray-500 py-4">Você ainda não participou de nenhum contrato.</td></tr>'}</tbody></table></div></div>`;
                    }
                }
                return `${renderHeader('Dashboard de Comissões')}<main class="p-6">${content}</main>`;
            }

            // --- Event Listeners & Handlers ---
            function attachEventListeners() {
                appEl.querySelector('#logoutBtn')?.addEventListener('click', () => signOut(auth));
                if (state.currentView === 'login') {
                    appEl.querySelector('#loginForm')?.addEventListener('submit', handleLogin);
                } else if (state.currentView === 'admin') {
                    appEl.addEventListener('click', handleAdminClicks);

                    if (state.adminAction === 'form' && state.adminView === 'contracts') {
                        attachContractFormListeners();
                    }
                }
            }
            
            function attachContractFormListeners() {
                const selectAll = document.getElementById('selectAllParticipants');
                const participantsContainer = document.getElementById('participants-container');
                if (!selectAll || !participantsContainer) return;

                const allCheckboxes = participantsContainer.querySelectorAll('input[name="participants"]');
                
                selectAll.checked = allCheckboxes.length > 0 && [...allCheckboxes].every(cb => cb.checked);
                selectAll.addEventListener('change', (e) => {
                    allCheckboxes.forEach(cb => cb.checked = e.target.checked);
                });
                participantsContainer.addEventListener('change', () => {
                    selectAll.checked = allCheckboxes.length > 0 && [...allCheckboxes].every(cb => cb.checked);
                });
            }

            async function handleLogin(e) { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); const originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = `<div class="loader loader-sm mx-auto"></div>`; try { await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value); } catch (error) { alert(`Falha no login: ${error.code}`); btn.disabled = false; btn.innerHTML = originalText; } }

            function handleAdminClicks(e) {
                const target = e.target;
                const type = target.closest('[data-type]')?.dataset.type;
                if (target.closest('.btn-add-item')) {
                    state.adminAction = 'form';
                    state.adminView = type === 'jobTitle' ? 'jobTitles' : type + 's';
                    state.selectedItemId = null;
                    render();
                } else if (target.closest('.btn-edit-item')) {
                    state.adminAction = 'form';
                    state.adminView = type === 'jobTitle' ? 'jobTitles' : type + 's';
                    state.selectedItemId = target.closest('[data-id]').dataset.id;
                    render();
                } else if (target.closest('.btn-back')) {
                    state.adminAction = 'list';
                    state.selectedItemId = null;
                    render();
                } else if (target.closest('.btn-danger-sm')) {
                    handleAdminDeleteClick(target.closest('[data-type]').dataset.type, target.closest('[data-id]').dataset.id);
                } else if (target.closest('aside a')) {
                    e.preventDefault();
                    state.adminView = target.closest('a').dataset.view;
                    state.adminAction = 'list';
                    state.selectedItemId = null;
                    location.hash = state.adminView;
                    render();
                } else if (target.id === 'saveSettingsBtn') {
                    const activeModelId = document.getElementById('activeModelSelect').value;
                    setDoc(settingsDocRef, { activeCommissionModelId: activeModelId }, { merge: true })
                        .then(() => alert('Configurações salvas com sucesso!'))
                        .catch(err => alert('Erro ao salvar configurações: ' + err.message));
                } else if (target.id === 'addTierBtn') {
                    const tableBody = document.querySelector('#tiers-table-container table tbody');
                    const newIndex = tableBody.rows.length;
                    const newRow = tableBody.insertRow();
                    newRow.id = `tier-row-${newIndex}`;
                    const sortedEmployees = getSortedEmployees();
                    newRow.innerHTML = `
                        <td><input type="text" class="form-input bg-gray-100" value="Faixa ${newIndex + 1}" disabled></td>
                        <td><input type="number" step="0.01" name="rangeInf" class="form-input" value=""></td>
                        <td><input type="number" step="0.01" name="rangeSup" class="form-input" placeholder="em branco para infinito" value=""></td>
                        ${sortedEmployees.map(e => `<td><input type="number" step="0.001" name="rate_${e.id}" class="form-input" value="0"></td>`).join('')}
                        <td><button type="button" class="btn-danger-sm remove-tier-btn" data-row-id="tier-row-${newIndex}">×</button></td>
                    `;
                } else if (target.classList.contains('remove-tier-btn')) {
                    target.closest('tr').remove();
                }
            }
            
            async function handleAdminDeleteClick(type, id) {
                if (confirm(`Tem certeza que deseja excluir este item?`)) {
                    try { 
                        const collectionName = type === 'jobTitle' ? 'jobTitles' : type + 's';
                        await deleteDoc(doc(db, collectionName, id));
                        if (type === 'commissionModel' && id === state.settings.activeCommissionModelId) {
                            await setDoc(settingsDocRef, { activeCommissionModelId: '' }, { merge: true });
                        }
                    } 
                    catch (error) { alert('Erro ao excluir: ' + error.message); }
                }
            }
            
            appEl.addEventListener('submit', (e) => {
                if (e.target.tagName === 'FORM') {
                    e.preventDefault();
                    let type = state.adminView;
                    if(type.endsWith('s')) type = type.slice(0, -1);
                    handleAdminFormSubmit(e.target, type, state.selectedItemId);
                }
            });

            async function handleAdminFormSubmit(form, type, id) {
                const formData = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                btn.disabled = true;

                try {
                    let data = {};
                    if (type === 'jobTitle') {
                        data = { name: formData.get('name'), order: parseInt(formData.get('order'), 10) };
                    }
                    else if (type === 'user' || type === 'employee' || type === 'contract') {
                         formData.forEach((value, key) => { if(key !== 'participants') data[key] = value; });
                        if (type === 'user') {
                            data.isManager = form.querySelector('[name="isManager"]').checked;
                            data.isAdmin = form.querySelector('[name="isAdmin"]').checked;
                        }
                        if (type === 'employee') {
                            data.salary = parseFloat(data.salary);
                            data.admissionDate = new Date(data.admissionDate + 'T00:00:00');
                        }
                        if (type === 'contract') {
                            data.value = parseFloat(data.value);
                            data.closingDate = new Date(data.closingDate + 'T00:00:00');
                            data.participants = Array.from(form.querySelectorAll('[name="participants"]:checked')).map(el => el.value);
                        }
                    } else if (type === 'commissionModel') {
                        data.name = formData.get('name');
                        data.tiers = [];
                        form.querySelectorAll('#tiers-table-container tbody tr').forEach(row => {
                            const rangeSupValue = parseFloat(row.querySelector('[name="rangeSup"]').value);
                            const tierData = {
                                rangeInf: parseFloat(row.querySelector('[name="rangeInf"]').value) || 0,
                                rangeSup: isNaN(rangeSupValue) || rangeSupValue === 0 ? null : rangeSupValue,
                                rates: {}
                            };
                            state.employees.forEach(emp => {
                                const rateInput = row.querySelector(`[name="rate_${emp.id}"]`);
                                if (rateInput) tierData.rates[emp.id] = parseFloat(rateInput.value || 0) / 100;
                            });
                            data.tiers.push(tierData);
                        });
                        data.tiers.sort((a,b) => a.rangeInf - b.rangeInf);
                    }
                    
                    const collectionName = type === 'jobTitle' ? 'jobTitles' : type + 's';
                    const collectionRef = collection(db, collectionName);
                    if (id) {
                        await setDoc(doc(collectionRef, id), data, { merge: true });
                    } else {
                        if (type === 'user') {
                             const password = formData.get('password');
                            if (!password || password.length < 6) throw new Error("Senha deve ter no mínimo 6 caracteres.");
                            const creationAppName = 'userCreationApp';
                            const creationApp = getApps().find(app => app.name === creationAppName) || initializeApp(firebaseConfig, creationAppName);
                            const tempAuth = getAuth(creationApp);
                            const userCredential = await createUserWithEmailAndPassword(tempAuth, data.email, password);
                            await setDoc(doc(usersCol, userCredential.user.uid), data);
                            await signOut(tempAuth);
                        } else {
                           await addDoc(collectionRef, data);
                        }
                    }
                    
                    state.adminAction = 'list';
                    render();
                } catch (error) {
                    alert(`Erro ao Salvar: ${error.message}`);
                    btn.disabled = false;
                }
            }
            
            // --- Initial Load ---
            function parseHash() {
                const h = window.location.hash.replace('#', '');
                const valid = ['dashboard', 'analysis', 'users', 'employees', 'contracts', 'commissionModels', 'jobTitles'];
                state.adminView = valid.includes(h) ? h : 'dashboard';
                state.adminAction = 'list';
                state.selectedItemId = null;
            }
            
            window.addEventListener('hashchange', () => {
                if (state.currentView === 'admin') {
                    parseHash();
                    render();
                }
            });
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 signInWithCustomToken(auth, __initial_auth_token).catch(err => console.error(err));
            }
        });
    </script>
</body>
</html>
